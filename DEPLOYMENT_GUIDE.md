# 树莓派部署与硬件连接指南

本指南将协助你将火灾监测系统部署到树莓派 5 上。

## 1. 硬件连接 (Wiring)

请务必在**断电**状态下进行接线！

### GPIO 引脚图参考

树莓派 5 的 GPIO 引脚布局与 4B/3B 一致。

- **3.3V**: Pin 1, 17
- **5V**: Pin 2, 4
- **GND**: Pin 6, 9, 14, 20, 25, ...

### 详细接线表

| 传感器/设备        | 模块引脚          | 树莓派引脚 (物理引脚号) | 树莓派 GPIO 编号 (BCM) | 备注                                                                                     |
| :----------------- | :---------------- | :---------------------- | :--------------------- | :--------------------------------------------------------------------------------------- |
| **DHT22** (温湿度) | VCC / +           | 3.3V (Pin 1)            | -                      | **注意电压**：建议接 3.3V                                                                |
|                    | GND / -           | GND (Pin 6)             | -                      |                                                                                          |
|                    | DATA / OUT        | Pin 7                   | **GPIO 4**             | 如果是裸传感器需加 4.7k 上拉电阻，成品模块通常已自带                                     |
| **MQ-2** (烟雾)    | VCC               | 5V (Pin 2)              | -                      | MQ-2 加热丝需要 5V 供电                                                                  |
|                    | GND               | GND (Pin 9)             | -                      |                                                                                          |
|                    | **DO** (数字输出) | Pin 11                  | **GPIO 17**            | **重要**: 如果模块输出是 5V 高电平，建议串联一个 1kΩ 电阻或使用电平转换，保护树莓派 GPIO |
|                    | AO (模拟输出)     | 不接                    | -                      | 树莓派没有模拟输入接口                                                                   |
| **USB 摄像头**     | USB               | 任意 USB 口             | -                      | 建议插在 USB 3.0 (蓝色) 接口                                                             |

> **⚠️ 安全警告**: 树莓派 GPIO 逻辑电平为 **3.3V**。MQ-2 传感器通常使用 5V 供电，其 DO 引脚输出的高电平可能也是 5V。直接连接可能会损坏树莓派 GPIO。
>
> - **安全方案**: 使用电平转换器，或简单的分压电路（电阻）。
> - **临时方案**: 如果没有电阻，可以尝试用 3.3V 给 MQ-2 供电（可能预热慢、读数不准，但安全），或者测量一下 DO 引脚的输出电压确认是否安全。

---

## 2. 代码传输 (Transfer Code)

由于你使用 SSH 连接，最简单的传输方式是使用 `scp` 命令或者 SFTP 软件（如 FileZilla）。

### 方法 A: 使用 SCP 命令 (推荐)

在你的**电脑端**（也就是你现在操作的这台机器，如果有终端环境）运行：

```powershell
# 假设树莓派用户名为 pi，IP 为 192.168.1.100
# 在 d:\fireDetect 目录下执行
scp -r . pi@192.168.1.100:~/fireDetect
```

### 方法 B: 使用 VNC 文件传输

1. 打开 VNC Viewer 连接树莓派。
2. 鼠标移到 VNC 窗口顶部中间，弹出工具栏。
3. 点击 **Transfer files** 图标。
4. 点击 **Send files**，选择电脑上的 `d:\fireDetect` 文件夹（或压缩包）发送到树莓派的 `/home/pi/` 目录。

### 方法 C: 使用 Git (推荐用于持续开发)

如果你已经将代码推送到 GitHub，这是最方便的方法。

1. **在树莓派终端**执行克隆命令：
   ```bash
   cd ~
   git clone https://github.com/你的用户名/fireDetect.git
   ```
2. 后续如果有代码更新，只需在树莓派项目目录下执行 `git pull` 即可同步。

---

## 3. 环境配置 (Setup Environment)

连接到树莓派的 SSH 终端，执行以下命令：

### 3.1 更新系统与安装系统库

```bash
sudo apt update
sudo apt upgrade -y
# 安装 OpenCV 依赖和 GPIO 库
sudo apt install -y python3-opencv libgpiod2 libatlas-base-dev
```

### 3.2 设置 Python 虚拟环境

为了防止污染系统 Python 环境，强烈建议使用虚拟环境：

```bash
# 进入项目目录
cd ~/fireDetect

# 创建虚拟环境 (名为 venv)
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate
```

_激活后，你的终端提示符前应该会出现 `(venv)` 字样。_

### 3.3 安装 Python 依赖

```bash
# 确保 pip 是最新的
pip install --upgrade pip

# 安装项目依赖 (这一步可能需要几分钟，取决于网络)
pip install -r requirements.txt
```

---

## 4. 配置与运行 (Run)

### 4.1 修改配置

使用 `nano` 编辑配置文件：

```bash
nano config.py
```

- 检查 `PIN_DHT22` 和 `PIN_MQ2` 是否与你的实际接线一致。
- **[可选]** 填入你的 `LLM_API_KEY` 以启用大模型火灾分析功能。
- 按 `Ctrl+O` 保存，`Enter` 确认，`Ctrl+X` 退出。

### 4.2 启动系统

确保摄像头已插入，执行：

```bash
python run.py
```

### 4.3 访问大屏

在电脑浏览器输入：`http://<树莓派IP>:8000`

- 如果看到画面和数据，说明部署成功！
- 用打火机气体（不点火）对着 MQ-2 测试烟雾报警。
- 对着摄像头哈气或用热源测试温湿度变化。

---

## 5. 常见问题排查

- **摄像头打不开**:
  - 检查 `ls /dev/video*` 是否有设备。
  - 尝试 `sudo chmod 777 /dev/video0` 赋予权限。
- **DHT22 读取失败**:
  - DHT22 对时序要求严格，偶尔读取失败（返回 None）是正常的，代码已做处理。如果一直失败，检查接线或更换 GPIO 口。
- **报错 `ModuleNotFoundError`**:
  - 确认你是否先执行了 `source venv/bin/activate` 进入了虚拟环境。
